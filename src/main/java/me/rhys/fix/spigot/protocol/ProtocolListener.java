package me.rhys.fix.spigot.protocol;

import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.ProtocolLibrary;
import com.comphenix.protocol.ProtocolManager;
import com.comphenix.protocol.events.ListenerPriority;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketContainer;
import com.comphenix.protocol.events.PacketEvent;
import me.rhys.fix.common.ConfigKeys;
import me.rhys.fix.spigot.Plugin;
import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.configuration.file.FileConfiguration;

import java.util.Locale;

public class ProtocolListener {

    public ProtocolListener() {
        ProtocolManager protocolManager = ProtocolLibrary.getProtocolManager();

        protocolManager.addPacketListener(
                new PacketAdapter(Plugin.getInstance(), ListenerPriority.NORMAL,
                        PacketType.Play.Client.CHAT) {

                    @Override
                    public void onPacketReceiving(PacketEvent event) {
                        PacketContainer packetContainer = event.getPacket();
                        String message = packetContainer.getStrings().read(0).toLowerCase(Locale.ROOT);
                      
                        if (message.contains("${jndi:")) {
                            event.setCancelled(true);
                            FileConfiguration configuration = Plugin.getInstance().getConfig();
                            if(configuration.getBoolean(ConfigKeys.NOTIFY_ENABLED)) {
                                String notifyMessage = ChatColor.translateAlternateColorCodes(
                                        '&',
                                        configuration.getString(ConfigKeys.NOTIFY_MESSAGE)
                                ).replace("%player%", event.getPlayer().getName());
                                Bukkit.getOnlinePlayers().stream()
                                        .filter(player -> player.hasPermission(configuration.getString(ConfigKeys.NOTIFY_PERMISSION)))
                                        .forEach(player -> player.sendMessage(notifyMessage));
                            }
                            if(configuration.getBoolean(ConfigKeys.PUNISHMENTS_ENABLED)) {
                                String command = configuration.getString(ConfigKeys.PUNISHMENTS_COMMAND)
                                        .replace("%player%", event.getPlayer().getName());
                                Bukkit.dispatchCommand(Bukkit.getConsoleSender(), command);
                            }
                        }
                    }
                }
        );
    }
}
